---
title: Survey Background
---

```{r setup, include=FALSE}
#| file: functions.R
```

## What we do

## Who is conducting the research?

Scientists from the Alaska Fisheries Science Center’s Groundfish Assessment Program (GAP) conduct these bottom trawl surveys with participation from the Alaska Department of Fish & Game (ADF&G), the International Pacific Halibut Commission (IPHC), universities, and other organizations. This research is conducted primarily on chartered fishing vessels.

## What is the research objective?

Learn more about the [program](https://www.fisheries.noaa.gov/alaska/science-data/groundfish-assessment-program-bottom-trawl-surveys). The objectives of these surveys are to:

 - monitor the population and environmental trends in the marine ecosystem of the Bering Sea, Aleutian Islands, and Gulf of Alaska, 
 - produce fishery-independent biomass (weight) and abundance (number) estimates for commercially important fish and crab species, and 
 - collect other biological and environmental data for use in ecosystem-based fishery management.

## Who is conducting the research?

Scientists from the Alaska Fisheries Science Center conduct these bottom trawl surveys with participation from the Alaska Department of Fish & Game (ADF&G), the International Pacific Halibut Commission (IPHC), and universities. This research is conducted on chartered fishing vessels.

## Bottom trawl surveys and regions

```{r survey-map, echo=FALSE, results='asis', eval = TRUE}
library(ggplot2)
library(viridis)
# devtools::install_github("afsc-gap-products/akgfmaps", build_vignettes = TRUE)
library(akgfmaps)
library(sf)

shp_ebs <- akgfmaps::get_base_layers(select.region = "bs.south", set.crs = "auto")
shp_nbs <- akgfmaps::get_base_layers(select.region = "bs.north", set.crs = "auto")
shp_ai <- akgfmaps::get_base_layers(select.region = "ai", set.crs = "auto")
shp_ai$survey.strata$Stratum <- shp_ai$survey.strata$STRATUM
shp_goa <- akgfmaps::get_base_layers(select.region = "goa", set.crs = "auto")
shp_goa$survey.strata$Stratum <- shp_goa$survey.strata$STRATUM
shp_bss <- akgfmaps::get_base_layers(select.region = "ebs.slope", set.crs = "auto")

shp_all <- shp <- dplyr::bind_rows(list(
  shp_ebs$survey.area %>%
    sf::st_transform(crs = "EPSG:3338") %>%
    dplyr::mutate(SURVEY = "EBS"),
  shp_nbs$survey.area  %>%
    sf::st_transform(crs = "EPSG:3338") %>%
    dplyr::mutate(SURVEY = "NBS"),
  shp_ai$survey.area %>%
    sf::st_transform(crs = "EPSG:3338") %>%
    dplyr::mutate(SURVEY = "AI"),
  shp_goa$survey.area %>%
    sf::st_transform(crs = "EPSG:3338") %>%
    dplyr::mutate(SURVEY = "GOA"),
  shp_bss$survey.area %>%
    sf::st_transform(crs = "EPSG:3338") %>%
    dplyr::mutate(SURVEY = "BSS"))) %>%
  dplyr::select(Survey = SURVEY, geometry)


plot_survey <- function(srvy = "ebs", print_plot = FALSE) {
  
  if (srvy == "all") {
    shp <- shp_ebs
    survey <- "All"
  } else if (srvy == "ebs") {
    shp <- shp_ebs
    survey <- "Eastern Bering Sea"
    stn_col <- "STATIONID"    
  } else if (srvy == "nbs") {
    shp <- shp_nbs
    survey <- "Northern Bering Sea"
    stn_col <- "STATIONID"    
  } else if (srvy == "bss") {
    shp <- shp_bss
    survey <- "Bering Sea Slope"  
    stn_col <- NULL
  } else if (srvy == "ai") {
    shp <- shp_ai
    survey <- "Aleutian Islands"
    stn_col <- "ID"    
  } else if (srvy == "goa") {
    shp <- shp_goa
    survey <- "Gulf of Alaska"
    stn_col <- "ID"
  }
  
gg <- ggplot() +
  ggplot2::geom_sf(data = shp$akland,
                   fill = "grey10",
                   color = "transparent") 
if (srvy == "all") {
  gg <- gg + 
      ggplot2::geom_sf(data = shp_nbs$graticule,
                   color = "grey90",
                   size = 0.5,
                   alpha = 0.5) +
  ggplot2::geom_sf(data = shp_ai$graticule,
                   color = "grey90",
                   size = 0.5,
                   alpha = 0.5) +
  ggplot2::geom_sf(data = shp_goa$graticule,
                   color = "grey90",
                   size = 0.5,
                   alpha = 0.5) +
  ggplot2::scale_x_continuous(name = "Longitude",
                              breaks = c(-180, -170, -160, -150, -140)) +
  ggplot2::scale_y_continuous(name = "Latitude") 
} else {
  gg <- gg + 
  ggplot2::geom_sf(data = shp$graticule,
                   color = "grey90",
                   size = 0.5,
                   alpha = 0.5) + 
  ggplot2::scale_x_continuous(name = "Longitude",
                              breaks = shp$lon.breaks) +
  ggplot2::scale_y_continuous(name = "Latitude", 
                              breaks = shp$lat.breaks) 
}

gg <- gg +
  ggplot2::ggtitle(label = paste0(survey, " Bottom Trawl Survey Regions"),
                   subtitle = "AFSC RACE Groundfish and Shellfish Public Data Coverage") +
  ggplot2::theme_classic() +
  ggplot2::theme(
    panel.background = element_rect(fill = "transparent"), #grey95
    plot.title = element_text(size = 12, face = "bold"),
    plot.subtitle = element_text(size=10),
    legend.text=element_text(size=8),
    legend.position="right",
    legend.direction="vertical",
    legend.justification="left",
    legend.background = element_blank(),
    legend.title=element_text(size=8),
    axis.text = element_text(size=8),
    legend.box.background = element_blank(),
    legend.key = element_blank(),
    legend.key.size=(unit(.3,"cm")),
    axis.title=element_text(size=14),
    plot.margin = margin(0,0,0,0,unit = "cm"))
  
if (srvy == "all") {
  gg <- gg  +
  ggplot2::geom_sf(data = shp_all,
                   mapping = aes(fill = Survey),
                   # color = "grey50",
                   show.legend = TRUE) +
  ggplot2::scale_fill_viridis_d(option = "G", end = 0.9, begin = 0.1) +
    ggplot2::coord_sf(xlim = c(-1394658,  2566293), # c(range(shp_ai$plot.boundary$x, shp_nbs$plot.boundary$x, shp_ebs$plot.boundary$x, shp_goa$plot.boundary$x, shp_bss$plot.boundary$x)),
                    ylim = c(-1028565.1,  1125549.7)) # range(shp_ai$plot.boundary$y, shp_nbs$plot.boundary$y, shp_ebs$plot.boundary$y, shp_goa$plot.boundary$y, shp_bss$plot.boundary$y))
} else {
    
# Station centroid data -------------------------------------------------------
gg <- gg  +
  ggplot2::geom_sf(data = shp$survey.strata,
                   fill = "grey80", 
                   color = "grey30",
                   alpha = .75,
                   show.legend = TRUE) 

if (!is.null(stn_col)) {

station_center <- shp$survey.grid |>
    sf::st_make_valid() |>
    sf::st_centroid() 

station_center <- data.frame(station = station_center[,stn_col]) |>
    dplyr::bind_cols(sf::st_coordinates(station_center)) |>
    dplyr::rename(longitude_dd = X, 
                  latitude_dd = Y, 
                  geometry = station.geometry) %>%
  dplyr::filter(!is.na(srvy)) %>%
  # dplyr::filter(!is.na(station)) %>%
  dplyr::filter(!is.na(longitude_dd)) %>%
  dplyr::filter(!is.na(latitude_dd))

gg <- gg  +
  ggplot2::geom_point(data = station_center, 
                   mapping = aes(x = longitude_dd, 
                                 y = latitude_dd), 
                   color = "grey20",
                   size = .1, 
                   alpha = .5,
                   show.legend = FALSE) 
}
  
gg <- gg  +
      # geom_sf(data = shp$bathymetry, 
      #         fill = NA, 
      #         color = "grey50")  +
      ggplot2::geom_text(data = subset(shp$place.labels, 
                              type == "mainland"), 
                aes(x = x, y = y, label = lab), 
                size = 3, group = 99) + 
      shadowtext::geom_shadowtext(data = subset(shp$place.labels, 
                                    type == "peninsula"), 
                      aes(x = x, y = y, label = lab), size = 4, angle = 30, 
                      bg.color = "white", color = "black", group = 99) + 
      shadowtext::geom_shadowtext(
        data = subset(shp$place.labels, 
                      type %in% c("bathymetry", "islands")),
        aes(x = x, y = y, label = lab), 
        bg.color = "white", color = "black", 
        size = 2, group = 99) 
if (srvy %in% c("nbs", "ebs")) {
gg <- gg  +
      ggplot2::geom_sf_text(data = shp$survey.strata, 
                   lineheight = 0.7,
                   mapping = aes(label = shp$survey.strata$Stratum),
                   color = "black",
                   size = 2,
                   show.legend = FALSE) 
}
gg <- gg  +
   ggplot2::coord_sf(xlim = range(shp$plot.boundary$x), 
                    ylim = range(shp$plot.boundary$y)) 
}
  
ggsave(filename = paste0("survey_plot_",srvy,".png"),
       plot = gg,
       path = here::here("img"),
       width = 7,
       height = 3)

if (print_plot){
  return(gg)
}

}
```

```{r survey-map-all-display}
#| label: srvy-bg-all
#| fig-cap: "Strata used in the all surveys. "
#| eval: true
#| echo: false
#| results: 'asis'
 
plot_survey(srvy = "all") 
knitr::include_graphics(path = here::here("img", "survey_plot_all.png"))
```

```{r source-current-tm, echo=FALSE}
source("https://raw.githubusercontent.com/afsc-gap-products/citations/main/cite/current_data_tm.r") # srvy_cite 
```

Each survey conducted by the [Groundfish Assessment Program](https://www.fisheries.noaa.gov/alaska/population-assessments/north-pacific-groundfish-stock-assessments-and-fishery-evaluation) are multispecies bottom trawl surveys. We collect environmental and biological data to assess how climate variability and [loss of sea](https://www.fisheries.noaa.gov/alaska/ecosystems/habitat-and-ecological-processes-research-regarding-loss-sea-ice) ice are affecting bottom-dwelling marine life on the Bering Sea shelf. We monitor trends in the distribution (location and movement patterns) and abundance of groundfish and crab species as well as oceanographic data (e.g., water temperature, depth). We collect biological information such as organism weight, length, stomachs to learn about diets, and [otoliths](https://www.fisheries.noaa.gov/alaska/science-data/alaska-age-and-growth-procedures-otolith-examination) to [determine fish ages](https://www.fisheries.noaa.gov/alaska/science-data/fish-otolith-chronologies). We use this information in [annual stock assessments](https://www.fisheries.noaa.gov/alaska/population-assessments/north-pacific-groundfish-stock-assessments-and-fishery-evaluation) and to assess the state of the ecosystem. This research is conducted on fishing industry contract vessels. 

```{r}
#| tbl-cap: Survey summary stats
#| message: false
#| warning: false
#| echo: false

dat_cruise <- RODBC::sqlQuery(channel = channel, 
                       query = 
"SELECT 
SURVEY_DEFINITION_ID, 
SURVEY_NAME, 
YEAR
FROM GAP_PRODUCTS.AKFIN_CRUISE cc") %>% 
  dplyr::left_join(y = data.frame(SURVEY_DEFINITION_ID = c(98, 143, 47, 52, 78), 
                                  SRVY = c("EBS", "NBS", "GOA", "AI", "BSS"))) %>% 
  dplyr::filter(!is.na(SRVY)) %>% 
  dplyr::distinct() %>%
                     dplyr::group_by(SRVY, SURVEY_DEFINITION_ID, SURVEY_NAME) %>% 
                     dplyr::summarise(YEARS = n(), 
                                      YEAR_S = max(YEAR, na.rm = T), 
                                      YEAR_E = min(YEAR, na.rm = T)) %>% 
                     unique()#)


dat_stratum <- RODBC::sqlQuery(channel = channel, 
                       query = 
"SELECT 
SURVEY_DEFINITION_ID, 
AREA_KM2, 
DESIGN_YEAR, 
DEPTH_MIN_M, 
DEPTH_MAX_M 
FROM GAP_PRODUCTS.AREA ss")  %>% 
  dplyr::left_join(y = data.frame(SURVEY_DEFINITION_ID = c(98, 143, 47, 52, 78), 
                                  SRVY = c("EBS", "NBS", "GOA", "AI", "BSS"))) %>% 
  dplyr::filter(!is.na(SRVY)) %>% 
      dplyr::group_by(SRVY, DESIGN_YEAR) %>%
      dplyr::summarise(STRATUM = n(), 
                       AREA_KM2 = sum(AREA_KM2, na.rm = TRUE), 
                       DEPTH_MIN_M = min(DEPTH_MIN_M, na.rm = TRUE), 
                       DEPTH_MAX_M = max(DEPTH_MAX_M, na.rm = TRUE)) %>% 
  dplyr::filter(!is.na(SRVY) & 
                  DESIGN_YEAR %in% max(DESIGN_YEAR)) %>% 
  dplyr::select(-DESIGN_YEAR)


dat_station <- RODBC::sqlQuery(channel = channel, 
                       query = 
"SELECT 
SRVY, 
STATION, 
DESIGN_YEAR
FROM GAP_PRODUCTS.OLD_STATION ss")  %>% 
  dplyr::left_join(y = data.frame(SURVEY_DEFINITION_ID = c(98, 143, 47, 52, 78), 
                                  SRVY = c("EBS", "NBS", "GOA", "AI", "BSS"))) %>% 
  dplyr::filter(!is.na(SURVEY_DEFINITION_ID)) %>% 
      dplyr::group_by(SRVY, DESIGN_YEAR) %>%
      dplyr::summarise(STATION = n()) %>% 
    dplyr::select(-DESIGN_YEAR)

table_raw <- dplyr::full_join(dat_stratum, dat_station) %>% 
  dplyr::full_join(dat_cruise) %>% 
    dplyr::ungroup()  %>% 
  dplyr::left_join(y = srvy_cite, 
                   by = "SRVY")%>%
  dplyr::mutate(Years = paste0(YEAR_S, " - ", YEAR_E, " (", YEARS, ")"), 
                area = paste0(formatC(x = AREA_KM2, format = "f", big.mark = ",", digits = 1)), 
                depth = paste0(formatC(x = DEPTH_MIN_M, format = "f", big.mark = ",", digits = 0), 
                               " - ", 
                               formatC(x = DEPTH_MAX_M, format = "f", big.mark = ",", digits = 0))#, 
                # Design = dplyr::case_when(
                #   SRVY == "AI" ~ "Triennial (1990s)/Biennial since 2000 in even years; Modified Index-Stratified Random of Successful Stations Survey Design", 
                # SRVY == "BSS" ~ "Intermittent (funding dependent); Modified Index-Stratified Random of Successful Stations Survey Design", 
                # SRVY == "EBS" ~ "Annual; Fixed stations at center of 20 x 20 nm grid", 
                # SRVY == "NBS" ~ "Biennial/Annual; Fixed stations at center of 20 x 20 nm grid", 
                # SRVY == "GOA" ~ "Triennial (1990s)/Biennial since 2001 in odd years; Stratified Random Survey Design"), 
                # CITE = paste0("@", CITE)
                ) %>% 
  dplyr::select(SURVEY_NAME, SURVEY_DEFINITION_ID, Years, depth, area, STRATUM, STATION) # , Citation = CITE, Design

library(ftExtra)

table_print <- table_raw %>% 
  flextable::flextable() %>% 
  flextable::set_header_labels(
    SURVEY_NAME = "Survey", 
    SURVEY_DEFINITION_ID = "Survey Definition ID", 
    depth = "Depth (m)", 
    area = "Area (km2)", 
    STRATUM = "# Statistical Areas", 
    STATION = "# Possible Stations" ) %>% 
  theme_flextable_nmfstm(x = ., 
                           font0 = "Arial", 
                           pad = 0, 
                           row_lines = FALSE, 
                           pgwidth = 8) %>% 
  flextable::fit_to_width(x = ., max_width = 11) %>%
  flextable::padding(padding = 5) %>% 
  flextable::theme_zebra() %>% 
  flextable::align(x = ., part = "body", align = "center", j = "SURVEY_DEFINITION_ID") %>% 
  flextable::width(j = "SURVEY_NAME", width = 1.5) %>%
  ftExtra::colformat_md()

table_print 
```

### **Aleutian Islands** 
Most recent data report: [@`r srvy_cite$CITE[srvy_cite$SRVY == "AI"]`]

- Upper Continental Slope of the Aleutian Islands from Unimak Pass to Stalemate Bank
- Triennial (1990s)/Biennial since 2000 in even years, since 1992
- Modified Index-Stratified Random of Successful Stations Survey Design
- Important commercial fish species include Atka mackerel, [Pacific ocean perch](https://www.fisheries.noaa.gov/species/pacific-ocean-perch), [walleye pollock](https://www.fisheries.noaa.gov/species/alaska-pollock), [Pacific cod](https://www.fisheries.noaa.gov/species/pacific-cod), [sablefish](https://www.fisheries.noaa.gov/species/sablefish), and other rockfish species. 

```{r survey-map-ai-display}
#| label: srvy-bg-ai
#| fig-cap: "Strata used in the Aleutian Islands bottom trawl survey. "
#| eval: true
#| echo: false
#| results: 'asis'
#| error: false
#| message: false
 
plot_survey(srvy = "ai") 
knitr::include_graphics(path = here::here("img", "survey_plot_ai.png"))
```

### **Gulf of Alaska** 
Most recent data report: [@`r srvy_cite$CITE[srvy_cite$SRVY == "GOA"]`]

- Continental Shelf and Upper Slope of the Gulf of Alaska extending from the Islands of Four Mountains 2,300 km east to Dixon Entrance
- Triennial (1990s)/Biennial since 2001 in odd years, since 1991
- Stratified Random Survey Design
- Important commercial species in the Gulf of Alaska include [Pacific ocean perch](https://www.fisheries.noaa.gov/species/pacific-ocean-perch), [walleye pollock](https://www.fisheries.noaa.gov/species/alaska-pollock), [Pacific cod](https://www.fisheries.noaa.gov/species/pacific-cod), flatfish, and other rockfish species. 

```{r survey-map-goa-display}
#| label: srvy-bg-goa
#| fig-cap: "Strata used in the Gulf of Alaska bottom trawl survey. "
#| eval: true
#| echo: false
#| results: 'asis'
#| error: false
#| message: false
  
plot_survey(srvy = "goa") 
knitr::include_graphics(path = here::here("img", "survey_plot_goa.png"))
```

### **Eastern Bering Sea Shelf** 
Most recent data report: [@`r srvy_cite$CITE[srvy_cite$SRVY == "EBS"]`]

- The continental shelf of the eastern Bering Sea from the Aleutian Islands to the Bering Strait
- Conducted annually since 1982. 
- Uses a stratified systematic sampling survey design with fixed stations at center of 20 x 20 nm grid. 
- Similar in design to the northern Bering Sea shelf bottom trawl survey. 
- Focus species for the Bering Sea include [walleye pollock](https://www.fisheries.noaa.gov/species/alaska-pollock), [Pacific cod](https://www.fisheries.noaa.gov/species/pacific-cod), [Greenland turbot](https://www.fisheries.noaa.gov/species/greenland-turbot), [yellowfin sole](https://www.fisheries.noaa.gov/species/yellowfin-sole), [northern rock sole](https://www.fisheries.noaa.gov/species/rock-sole), [red king crab](https://www.fisheries.noaa.gov/species/red-king-crab), and [snow](https://www.fisheries.noaa.gov/species/alaska-snow-crab) and Tanner crabs.

```{r survey-map-ebs-display}
#| label: srvy-bg-ebs
#| fig-cap: "Strata used in the Eastern Bering Sea bottom trawl survey. "
#| eval: true
#| echo: false
#| results: 'asis'
#| error: false
#| message: false
  
# knitr::include_graphics(path = here::here("img", "ebs-strata.png"))

plot_survey(srvy = "ebs") 
knitr::include_graphics(path = here::here("img", "survey_plot_ebs.png"))
```

### **Northern Bering Sea** 
Most recent data report: [@`r srvy_cite$CITE[srvy_cite$SRVY == "NBS"]`]

- The continental shelf of the northern Bering Sea, including the area north of St. Lawrence Island and Norton Sound
- Biennial/Annual; conducted intermittently since 2010
- Uses a stratified systematic sampling survey design with fixed stations at center of 20 x 20 nm grid. 
- Similar in design to the eastern Bering Sea shelf bottom trawl survey. 

```{r survey-map-nbs-display}
#| label: srvy-bg-nbs
#| fig-cap: "Strata used in the Northern Bering Sea bottom trawl survey. "
#| eval: true
#| echo: false
#| results: 'asis'
#| error: false
#| message: false

plot_survey(srvy = "nbs") 
knitr::include_graphics(path = here::here("img", "survey_plot_nbs.png"))
```

### **Eastern Bering Sea Upper Continental Slope** 
Most recent data report: [@`r srvy_cite$CITE[srvy_cite$SRVY == "BSS"]`]

- The eastern Bering Sea upper continental slope survey area extends from Unalaska and Akutan Islands to the U.S.-Russian Maritime Boundary at 61° N near the International Date Line (166° E to 180° W) at depths from 200 to 1,200 m
- Conducted intermittently since 2002 (funding dependent)
- Modified Index-Stratified Random of Successful Stations Survey Design
- Focus species for the Bering Sea slope include giant grenadier, [Pacific ocean perch](https://www.fisheries.noaa.gov/species/pacific-ocean-perch), popeye grenadier, [walleye pollock](https://www.fisheries.noaa.gov/species/alaska-pollock), and [arrowtooth flounder](https://www.fisheries.noaa.gov/species/arrowtooth-flounder). 


```{r survey-map-bss-display}
#| label: srvy-bg-bss
#| fig-cap: "Strata used in the Bering Sea Slope bottom trawl survey. "
#| eval: true
#| echo: false
#| results: 'asis'
#| error: false
#| message: false
  
knitr::include_graphics(path = here::here("img", "bss-strata.png"))

# plot_survey(srvy = "bss") 
# knitr::include_graphics(path = here::here("img", "survey_plot_bss.png"))
```
